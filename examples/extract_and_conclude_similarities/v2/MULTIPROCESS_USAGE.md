# Multi-process Speaker Embedding Computation

## æ¦‚è¿°

å¤šè¿›ç¨‹ç‰ˆæœ¬çš„è¯´è¯äººembeddingè®¡ç®—è„šæœ¬é€šè¿‡å¹¶è¡Œå¤„ç†å¤šä¸ªè¯´è¯äººï¼Œå¤§å¹…æå‡è®¡ç®—æ•ˆç‡ã€‚ç›¸æ¯”å•è¿›ç¨‹ç‰ˆæœ¬ï¼Œå¯ä»¥è·å¾—æ¥è¿‘CPUæ ¸å¿ƒæ•°å€çš„æ€§èƒ½æå‡ã€‚

## æ ¸å¿ƒæ”¹è¿›

### ğŸš€ æ€§èƒ½æå‡
- **å¹¶è¡Œå¤„ç†**: åŒæ—¶å¤„ç†å¤šä¸ªè¯´è¯äººçš„embeddingè®¡ç®—
- **è´Ÿè½½å‡è¡¡**: æ™ºèƒ½åˆ†é…è¯´è¯äººåˆ°ä¸åŒè¿›ç¨‹
- **èµ„æºä¼˜åŒ–**: å……åˆ†åˆ©ç”¨å¤šæ ¸CPUèµ„æº
- **è¿›åº¦ç›‘æ§**: å®æ—¶æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„å¤„ç†çŠ¶æ€

### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
- **å¤šè¿›ç¨‹æ¶æ„**: ä½¿ç”¨`multiprocessing.Pool`è¿›è¡Œå¹¶è¡Œè®¡ç®—
- **æ‰¹å¤„ç†**: å°†è¯´è¯äººåˆ†ç»„åˆ°ä¸åŒçš„æ‰¹æ¬¡è¿›è¡Œå¤„ç†
- **é”™è¯¯éš”ç¦»**: å•ä¸ªè¿›ç¨‹é”™è¯¯ä¸å½±å“å…¶ä»–è¿›ç¨‹
- **å†…å­˜ç®¡ç†**: æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹çš„å†…å­˜ç©ºé—´

## æ–‡ä»¶ç»“æ„

```
â”œâ”€â”€ compute_speaker_embeddings_multiprocess.py    # å¤šè¿›ç¨‹è®¡ç®—è„šæœ¬
â”œâ”€â”€ run_compute_speaker_embeddings_multiprocess.sh # å¤šè¿›ç¨‹è¿è¡Œè„šæœ¬
â”œâ”€â”€ test_speaker_embeddings_multiprocess.py       # å¤šè¿›ç¨‹æµ‹è¯•è„šæœ¬
â””â”€â”€ MULTIPROCESS_USAGE.md                         # ä½¿ç”¨è¯´æ˜æ–‡æ¡£
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¿«é€Ÿå¼€å§‹

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œ
./run_compute_speaker_embeddings_multiprocess.sh
```

### 2. è‡ªå®šä¹‰å‚æ•°

```bash
# ç›´æ¥è¿è¡ŒPythonè„šæœ¬
python3 compute_speaker_embeddings_multiprocess.py \
    --utterances_dir /path/to/utterances \
    --speakers_dir /path/to/speakers \
    --num_processes 8 \
    --chunk_size 10 \
    --min_utterances 2 \
    --skip_existing
```

### 3. å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--utterances_dir` | é¢„è®¾è·¯å¾„ | è¾“å…¥çš„utterance embeddingsç›®å½• |
| `--speakers_dir` | é¢„è®¾è·¯å¾„ | è¾“å‡ºçš„speaker embeddingsç›®å½• |
| `--num_processes` | `nproc` | ä½¿ç”¨çš„è¿›ç¨‹æ•°é‡ |
| `--chunk_size` | 10 | æ¯ä¸ªæ‰¹æ¬¡å¤„ç†çš„è¯´è¯äººæ•°é‡ |
| `--min_utterances` | 1 | è¯´è¯äººæœ€å°‘utteranceæ•°é‡ |
| `--skip_existing` | True | è·³è¿‡å·²å­˜åœ¨çš„è¯´è¯äºº |

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ğŸ¯ è¿›ç¨‹æ•°é‡ä¼˜åŒ–

```bash
# è·å–CPUæ ¸å¿ƒæ•°
nproc
# ä¸€èˆ¬è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°æˆ–ç¨å°‘
--num_processes $(nproc)
```

### ğŸ“¦ æ‰¹æ¬¡å¤§å°ä¼˜åŒ–

```bash
# å°æ‰¹æ¬¡ (é€‚åˆå†…å­˜é™åˆ¶)
--chunk_size 5

# å¤§æ‰¹æ¬¡ (é€‚åˆé«˜æ€§èƒ½æœåŠ¡å™¨)
--chunk_size 20
```

### ğŸ’¾ I/Oä¼˜åŒ–

- **SSDå­˜å‚¨**: ä½¿ç”¨SSDå­˜å‚¨å¯ä»¥æ˜¾è‘—æå‡I/Oæ€§èƒ½
- **ç½‘ç»œå­˜å‚¨**: é¿å…ä½¿ç”¨ç½‘ç»œå­˜å‚¨ï¼Œä¼˜å…ˆæœ¬åœ°å­˜å‚¨
- **å¹¶å‘I/O**: å¤šè¿›ç¨‹å¤©ç„¶æ”¯æŒå¹¶å‘I/Oæ“ä½œ

## æ€§èƒ½ç›‘æ§

### ç³»ç»Ÿèµ„æºç›‘æ§

```bash
# ç›‘æ§CPUä½¿ç”¨ç‡
htop

# ç›‘æ§å†…å­˜ä½¿ç”¨
free -h

# ç›‘æ§ç£ç›˜I/O
iotop
```

### è¿›ç¨‹çŠ¶æ€ç›‘æ§

è„šæœ¬ä¼šå®æ—¶æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„å¤„ç†çŠ¶æ€ï¼š

```
Processing batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [00:30<00:00, 7.5s/it]
P0: âœ…15 â­ï¸3 âŒ0  P1: âœ…12 â­ï¸5 âŒ1  P2: âœ…18 â­ï¸2 âŒ0  P3: âœ…14 â­ï¸4 âŒ0
```

- âœ… æˆåŠŸå¤„ç†çš„è¯´è¯äººæ•°é‡
- â­ï¸ è·³è¿‡çš„è¯´è¯äººæ•°é‡ (å·²å­˜åœ¨)
- âŒ å¤„ç†å¤±è´¥çš„è¯´è¯äººæ•°é‡

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³**
   ```bash
   # å‡å°‘è¿›ç¨‹æ•°é‡
   --num_processes 4
   
   # å‡å°‘æ‰¹æ¬¡å¤§å°
   --chunk_size 5
   ```

2. **ç£ç›˜ç©ºé—´ä¸è¶³**
   ```bash
   # æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
   df -h
   
   # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   find /tmp -name "*.pkl" -delete
   ```

3. **è¿›ç¨‹æ­»é”**
   ```bash
   # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
   ps aux | grep compute_speaker
   
   # å¼ºåˆ¶ç»ˆæ­¢
   pkill -f compute_speaker_embeddings_multiprocess
   ```

## æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå¤šè¿›ç¨‹æµ‹è¯•
python3 test_speaker_embeddings_multiprocess.py
```

### æ€§èƒ½å¯¹æ¯”æµ‹è¯•

```bash
# å•è¿›ç¨‹ç‰ˆæœ¬
time python3 compute_speaker_embeddings.py --utterances_dir /path/to/data

# å¤šè¿›ç¨‹ç‰ˆæœ¬
time python3 compute_speaker_embeddings_multiprocess.py --utterances_dir /path/to/data --num_processes 8
```

## æœ€ä½³å®è·µ

### ğŸ¯ é…ç½®å»ºè®®

1. **è¿›ç¨‹æ•°é‡**: è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°çš„80-100%
2. **æ‰¹æ¬¡å¤§å°**: æ ¹æ®å†…å­˜å¤§å°è°ƒæ•´ï¼Œä¸€èˆ¬5-20ä¸ªè¯´è¯äºº
3. **æœ€å°utterances**: æ ¹æ®å®é™…éœ€æ±‚è®¾ç½®ï¼Œé¿å…è¿‡å°‘çš„è¯´è¯äººæ•°æ®

### ğŸ”§ ä½¿ç”¨æŠ€å·§

1. **é¢„å¤„ç†**: ç¡®ä¿è¾“å…¥æ•°æ®æ ¼å¼æ­£ç¡®ä¸”å®Œæ•´
2. **ç›‘æ§**: è¿è¡Œæ—¶ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
3. **å¤‡ä»½**: é‡è¦æ•°æ®åŠ¡å¿…åšå¥½å¤‡ä»½
4. **æ—¥å¿—**: ä¿ç•™è¿è¡Œæ—¥å¿—ç”¨äºé—®é¢˜æ’æŸ¥

### âš¡ æ€§èƒ½æœŸæœ›

- **ç†è®ºåŠ é€Ÿæ¯”**: æ¥è¿‘è¿›ç¨‹æ•°é‡å€æ•°
- **å®é™…åŠ é€Ÿæ¯”**: å—I/Oé™åˆ¶ï¼Œé€šå¸¸ä¸ºè¿›ç¨‹æ•°é‡çš„60-80%
- **å†…å­˜ä½¿ç”¨**: æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹ä½¿ç”¨å†…å­˜
- **ç£ç›˜I/O**: å¤šè¿›ç¨‹å¹¶å‘è¯»å†™ï¼Œéœ€è¦é«˜æ€§èƒ½å­˜å‚¨

## è¾“å‡ºæ ¼å¼

å¤šè¿›ç¨‹ç‰ˆæœ¬çš„è¾“å‡ºæ ¼å¼ä¸å•è¿›ç¨‹ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼š

```python
# è¯´è¯äººembeddingæ–‡ä»¶ç»“æ„
{
    'embedding': np.ndarray,           # å¹³å‡embeddingå‘é‡
    'dataset': str,                    # æ•°æ®é›†åç§°
    'speaker_id': str,                 # è¯´è¯äººID
    'num_utterances': int,             # utteranceæ•°é‡
    'failed_utterances': int,          # å¤±è´¥çš„utteranceæ•°é‡
    'utterance_list': List[str],       # utterance IDåˆ—è¡¨
    'original_paths': List[str],       # åŸå§‹æ–‡ä»¶è·¯å¾„åˆ—è¡¨
    'embedding_dim': int,              # embeddingç»´åº¦
    'embedding_stats': {               # embeddingç»Ÿè®¡ä¿¡æ¯
        'mean': float,
        'std': float,
        'min': float,
        'max': float
    }
}
```

## æ³¨æ„äº‹é¡¹

1. **å…¼å®¹æ€§**: ç¡®ä¿Pythonç‰ˆæœ¬æ”¯æŒmultiprocessing
2. **èµ„æºé™åˆ¶**: æ³¨æ„ç³»ç»Ÿå†…å­˜å’ŒCPUé™åˆ¶
3. **æ–‡ä»¶é”**: é¿å…åŒæ—¶å†™å…¥åŒä¸€æ–‡ä»¶
4. **é”™è¯¯å¤„ç†**: å•ä¸ªè¿›ç¨‹é”™è¯¯ä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹
5. **ç»“æœä¸€è‡´æ€§**: å¤šè¿›ç¨‹ç»“æœä¸å•è¿›ç¨‹ç»“æœå®Œå…¨ä¸€è‡´ 